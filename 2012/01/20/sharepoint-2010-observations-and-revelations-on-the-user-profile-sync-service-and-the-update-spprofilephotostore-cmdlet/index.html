<!DOCTYPE html>
<html lang="en">
    <head prefix="og: http://ogp.me/ns#">
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="HandheldFriendly" content="True" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="description" content="Jon Badgett's personal blog. Open source projects, observations on life, and other oddities I find interesting." />
        <title>SharePoint 2010: Observations and Revelations on the User Profile Sync Service and the Update-SPProfilePhotoStore cmdlet &ndash; JonTheNerd</title>
        <meta name="color-scheme" content="dark light" />
        <script>
            if (window.matchMedia("(prefers-color-scheme: dark)").media ==="not all") {
                document.documentElement.style.display = "none";
                document.head.insertAdjacentHTML(
                    "beforeend",
                    '<link rel="stylesheet" href="/assets/light.css" onload="document.documentElement.style.display = \'\'">'
                );
            }
        </script>
        <link rel="stylesheet" media="(prefers-color-scheme: light)" href="/assets/light.css" />
        <link rel="stylesheet" media="(prefers-color-scheme: dark)" href="/assets/dark.css" />
        <link rel="stylesheet" href="/assets/style.css" />
        
    </head>
    <body>
        <header class="site-header">
    <div class="container">
        <h1>
            <a href="/">JonTheNerd</a>
        </h1>
        <nav>
            <ul>
                <li><a href="/about">About</a></li>
            </ul>
        </nav>
    </div>
</header>

        <main>
            
<article class="single" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="name headline">
            <div class="container">SharePoint 2010: Observations and Revelations on the User Profile Sync Service and the Update-SPProfilePhotoStore cmdlet</div>
        </h1>
        <div class="post-meta">
            <div class="container">
                <time datetime=" 2012-01-20" itemprop="datePublished">January 20, 2012</time>
                
                | Posted in
                <a
                    href="/categories/programming">Programming</a>, <a
                    href="/categories/sysadmin">SysAdmin</a>
                
                
                | Tagged with
                <a
                    href="/tags/sharepoint">SharePoint</a>
                
            </div>
        </div>
    </header>
    <div itemprop="articleBody">
        <div class="container">
            <p>These are my notes while trying to diagnose and better understnad some issues
and oddities with the SharePoint 2010 User Profile Service Application.</p>
<p>If you&rsquo;re wanting to populate pictures into people&rsquo;s profiles, you&rsquo;ll be using
the Update-SPProfilePhotoStore powershell cmdlet after a normal sync (full or
incremental - or your custom built one). This cmdlet is in
the <code>Microsoft.Office.Server.UserProfiles</code> dll, specifically the
<code>Microsoft.Office.Server.UserProfiles.PowerShell.SPCmdletUserProfilePhotoStore</code>
class. Thanks to the goodness that is
<!-- raw HTML omitted -->Redgate Reflector<!-- raw HTML omitted --> (a must have for any
SP developer), we can get a more clear undertanding of what the cmdlet is doing.
I&rsquo;ve written some comments to help understand what&rsquo;s going on, as well as
renamed some variables for the section I was more interested in understanding.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[Cmdlet(&#34;Update&#34;, &#34;SPProfilePhotoStore&#34;)]</span>
</span></span><span class="line"><span class="cl"><span class="k">internal</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">SPCmdletUserProfilePhotoStore</span> <span class="p">:</span> <span class="n">SPCmdlet</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fields</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">bool?</span> <span class="n">m_createThumbnailsForImportedPhotos</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="kt">bool?</span> <span class="n">m_noDelete</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">SPFolder</span> <span class="n">m_profilePicFolder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">SPSitePipeBind</span> <span class="n">m_SiteMySiteHost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="n">UserProfileManager</span> <span class="n">m_userProfileManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Constructor</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">SPCmdletUserProfilePhotoStore</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">m_createThumbnailsForImportedPhotos</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">m_noDelete</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Methods</span>
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">InternalProcessRecord</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Run the below section if -CreateThumbnailsForImportedPhotos has NOT been specified.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">m_createThumbnailsForImportedPhotos</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Enumerate through all UserProfiles</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="n">UserProfile</span> <span class="n">profile</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Get the PictureURL property of the user profile</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">object</span> <span class="n">obj2</span> <span class="p">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#34;PictureURL&#34;</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">((</span><span class="n">obj2</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span> <span class="n">obj2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// This user has a PictureURL property. Get the path</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#34;PictureURL&#34;</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">string</span> <span class="n">format</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_GenericError_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">format</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">Value</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// If the PictureURL property has a link to the medium thumbnail, don&#39;t process further.</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(!</span><span class="n">Path</span><span class="p">.</span><span class="n">GetFileNameWithoutExtension</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&#34;_MThumb&#34;</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">bool</span> <span class="n">flag</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">try</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="k">using</span> <span class="p">(</span><span class="n">SPSite</span> <span class="n">site</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SPSite</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">using</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">web</span> <span class="p">=</span> <span class="n">site</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="c1">// Try and get a reference to the file specified. This can be in SharePoint somewhere on on another webserver.</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">SPFile</span> <span class="n">file</span> <span class="p">=</span> <span class="n">web</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">Exists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">try</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">buffer</span> <span class="p">=</span> <span class="n">file</span><span class="p">.</span><span class="n">OpenBinary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                                <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">format</span> <span class="p">+</span> <span class="n">exception</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">buffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// The file doesn&#39;t exist. Write an error.</span>
</span></span><span class="line"><span class="cl">                                            <span class="kt">string</span> <span class="n">str4</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_FileNotFound_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">str4</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">CurrentCulture</span><span class="p">,</span> <span class="n">str4</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">path</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">FileNotFoundException</span><span class="p">(</span><span class="n">format</span> <span class="p">+</span> <span class="n">str4</span><span class="p">),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="k">catch</span> <span class="p">(</span><span class="n">FileNotFoundException</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// File wasn&#39;t found using Object Model. Maybe it&#39;s on another webserver. Try and open the file using a WebClient instead of the Object Model</span>
</span></span><span class="line"><span class="cl">                                <span class="k">try</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">WebClient</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">CredentialCache</span> <span class="n">cache</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CredentialCache</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">cache</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s">&#34;Ntlm&#34;</span><span class="p">,</span> <span class="n">CredentialCache</span><span class="p">.</span><span class="n">DefaultNetworkCredentials</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">client</span><span class="p">.</span><span class="n">Credentials</span> <span class="p">=</span> <span class="n">cache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">buffer</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">DownloadData</span><span class="p">(</span><span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">path</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">format</span> <span class="p">+</span> <span class="n">exception2</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">buffer</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">string</span> <span class="n">str5</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// Did we read the file into memory?</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">str7</span> <span class="p">=</span> <span class="n">UrlUtility</span><span class="p">.</span><span class="n">ConvertToLegalFileName</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="sc">&#39;_&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">str8</span> <span class="p">=</span> <span class="s">&#34;.jpg&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="k">try</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">using</span> <span class="p">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Bitmap</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a large thumbnail</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">LargeThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">LargeThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str7</span> <span class="p">+</span> <span class="s">&#34;_LThumb&#34;</span> <span class="p">+</span> <span class="n">str8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a medium thumbnail</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">SPFile</span> <span class="n">file2</span> <span class="p">=</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">MediumThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">MediumThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str7</span> <span class="p">+</span> <span class="s">&#34;_MThumb&#34;</span> <span class="p">+</span> <span class="n">str8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a small thumbnail</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">SmallThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">SmallThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str7</span> <span class="p">+</span> <span class="s">&#34;_SThumb&#34;</span> <span class="p">+</span> <span class="n">str8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Get a URL to the Medium Size Thumbnail</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">str5</span> <span class="p">=</span> <span class="n">UrlUtility</span><span class="p">.</span><span class="n">EnsureTrailingSlash</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">.</span><span class="n">MySiteHostUrl</span><span class="p">)</span> <span class="p">+</span> <span class="n">file2</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">format</span> <span class="p">+</span> <span class="n">exception3</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">flag</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// If the URL to the medium thumbnail isn&#39;t null and we successfully created the thumbnails...</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">((</span><span class="n">str5</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// Set the PictureURL value</span>
</span></span><span class="line"><span class="cl">                                <span class="n">profile</span><span class="p">[</span><span class="s">&#34;PictureURL&#34;</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">str5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="n">profile</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// Write to the log (verbose) that we set the Picture up.</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">str9</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_PhotoMoved_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="n">str9</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="n">str9</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">ToString</span><span class="p">(),</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">ToLongTimeString</span><span class="p">()</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">                                <span class="k">base</span><span class="p">.</span><span class="n">WriteVerbose</span><span class="p">(</span><span class="n">str9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">string</span> <span class="n">str10</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_GenericError_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">str10</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="n">str10</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">profile</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">Value</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">str10</span> <span class="p">+</span> <span class="n">exception4</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Run the below section if -CreateThumbnailsForImported has been specified</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Get the MySiteHost Site Collection</span>
</span></span><span class="line"><span class="cl">            <span class="k">using</span> <span class="p">(</span><span class="n">SPSite</span> <span class="n">site2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SPSite</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">.</span><span class="n">MySiteHostUrl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Access the MySiteHost RootWeb</span>
</span></span><span class="line"><span class="cl">                <span class="k">using</span> <span class="p">(</span><span class="n">SPWeb</span> <span class="n">web2</span> <span class="p">=</span> <span class="n">site2</span><span class="p">.</span><span class="n">RootWeb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Get the PhotoListURL</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">string</span> <span class="n">importPhotoListUrl</span> <span class="p">=</span> <span class="n">UserProfileGlobal</span><span class="p">.</span><span class="n">GetImportPhotoListUrl</span><span class="p">(</span><span class="n">ProfileType</span><span class="p">.</span><span class="n">User</span><span class="p">)</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span> <span class="p">+</span> <span class="n">UserProfileGlobal</span><span class="p">.</span><span class="n">GetImportPhotoFolderName</span><span class="p">(</span><span class="n">web2</span><span class="p">.</span><span class="n">Locale</span><span class="p">)</span> <span class="p">+</span> <span class="s">&#34;/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Enumerate through all UserProfiles</span>
</span></span><span class="line"><span class="cl">                    <span class="k">foreach</span> <span class="p">(</span><span class="n">UserProfile</span> <span class="n">profile2</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// Get the filename of the photo, then the url to the photo, and finally the file itself</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// This is a combination of the UserProfileManager PartitionID (internal property) and the RecordId of the profile. This is the temporary picture file.</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">string</span> <span class="n">importPhotoFilename</span> <span class="p">=</span> <span class="n">UserProfileGlobal</span><span class="p">.</span><span class="n">GetImportPhotoFilename</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">,</span> <span class="n">profile2</span><span class="p">.</span><span class="n">RecordId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="kt">string</span> <span class="n">importPhotoFilenameWithListUrl</span> <span class="p">=</span> <span class="n">importPhotoListUrl</span> <span class="p">+</span> <span class="n">importPhotoFilename</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">SPFile</span> <span class="n">file3</span> <span class="p">=</span> <span class="n">web2</span><span class="p">.</span><span class="n">GetFile</span><span class="p">(</span><span class="n">importPhotoFilenameWithListUrl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                        <span class="c1">// If the file exists, run below.</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">((</span><span class="n">file3</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="n">file3</span><span class="p">.</span><span class="n">Exists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// Format an error message in case we need it later.</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">string</span> <span class="n">str15</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_GenericError_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="n">str15</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="n">str15</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">file3</span><span class="p">.</span><span class="n">ToString</span><span class="p">(),</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">profile2</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">Value</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="c1">// Try opening the file and reading it into memory</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">try</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">buffer2</span> <span class="p">=</span> <span class="n">file3</span><span class="p">.</span><span class="n">OpenBinary</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// There was an exeption reading the picture file into memory. Write this error to a log, then set the buffer to null</span>
</span></span><span class="line"><span class="cl">                                <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">str15</span> <span class="p">+</span> <span class="n">exception5</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="n">buffer2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            <span class="c1">// Check and see if we were able to read the file into memory successfully. Run below if we could.</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="n">buffer2</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// We&#39;ve got the temporary file in memory. Determine what we should rename it</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">str17</span> <span class="p">=</span> <span class="n">profile2</span><span class="p">[</span><span class="s">&#34;AccountName&#34;</span><span class="p">].</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">Replace</span><span class="p">(</span><span class="s">@&#34;\&#34;</span><span class="p">,</span> <span class="s">&#34;_&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">str18</span> <span class="p">=</span> <span class="s">&#34;.jpg&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">string</span> <span class="n">mediumThumbnailURL</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="kt">bool</span> <span class="n">createThumbnailsSuccess</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="k">try</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">stream2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">buffer2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">using</span> <span class="p">(</span><span class="n">Bitmap</span> <span class="n">bitmap2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Bitmap</span><span class="p">(</span><span class="n">stream2</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a Thumbnail - large size</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap2</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">LargeThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">LargeThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str17</span> <span class="p">+</span> <span class="s">&#34;_LThumb&#34;</span> <span class="p">+</span> <span class="n">str18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a Thumbanil - medium size, and get a reference to the file it creates</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">SPFile</span> <span class="n">file4</span> <span class="p">=</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap2</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">MediumThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">MediumThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str17</span> <span class="p">+</span> <span class="s">&#34;_MThumb&#34;</span> <span class="p">+</span> <span class="n">str18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Create a Thumbnail - small size</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">CreateThumbnail</span><span class="p">(</span><span class="n">bitmap2</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">SmallThumbnailSize</span><span class="p">,</span> <span class="n">UserProfilePhotos</span><span class="p">.</span><span class="n">SmallThumbnailSize</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span><span class="p">,</span> <span class="n">str17</span> <span class="p">+</span> <span class="s">&#34;_SThumb&#34;</span> <span class="p">+</span> <span class="n">str18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                            <span class="c1">// Build a URL that points to the medium size thumbnail</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">mediumThumbnailURL</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">.</span><span class="n">MySiteHostUrl</span> <span class="p">+</span> <span class="n">file4</span><span class="p">.</span><span class="n">Url</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">base</span><span class="p">.</span><span class="n">WriteError</span><span class="p">(</span><span class="k">new</span> <span class="n">SPException</span><span class="p">(</span><span class="n">str15</span> <span class="p">+</span> <span class="n">exception6</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">WriteError</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">createThumbnailsSuccess</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="c1">// Have we successfully created the thumbnails and have a path to the medium thumbnail?</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="p">(</span><span class="n">createThumbnailsSuccess</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">mediumThumbnailURL</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="c1">// Set the PictureURL property</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">profile2</span><span class="p">[</span><span class="s">&#34;PictureURL&#34;</span><span class="p">].</span><span class="n">Value</span> <span class="p">=</span> <span class="n">mediumThumbnailURL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">profile2</span><span class="p">.</span><span class="n">Commit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                    <span class="c1">// If -NoDelete wasn&#39;t specified, then delete the image with the Guid_ID pattern for this user profile.</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">m_noDelete</span><span class="p">.</span><span class="n">HasValue</span> <span class="p">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_noDelete</span> <span class="p">==</span> <span class="k">false</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">file3</span><span class="p">.</span><span class="n">Delete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">InternalValidate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SPSite</span> <span class="n">site</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">MySiteHostLocation</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">site</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_NullMySiteHost_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">base</span><span class="p">.</span><span class="n">ThrowTerminatingError</span><span class="p">(</span><span class="k">new</span> <span class="n">ArgumentException</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">InvalidArgument</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">SPServiceContext</span> <span class="n">serviceContext</span> <span class="p">=</span> <span class="n">SPServiceContext</span><span class="p">.</span><span class="n">GetContext</span><span class="p">(</span><span class="n">site</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">serviceContext</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">str2</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_ServerContextNotFound_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">base</span><span class="p">.</span><span class="n">ThrowTerminatingError</span><span class="p">(</span><span class="k">new</span> <span class="n">ArgumentException</span><span class="p">(</span><span class="n">str2</span><span class="p">),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span> <span class="p">=</span> <span class="k">new</span> <span class="n">UserProfileManager</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">str3</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_ProfManagerNotFound_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">base</span><span class="p">.</span><span class="n">ThrowTerminatingError</span><span class="p">(</span><span class="k">new</span> <span class="n">ArgumentException</span><span class="p">(</span><span class="n">str3</span><span class="p">),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">.</span><span class="n">IsProfileAdmin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">string</span> <span class="n">str4</span> <span class="p">=</span> <span class="n">StringResourceManager</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="s">&#34;Powershell_MovePictures_NotProfileAdmin_Text&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">base</span><span class="p">.</span><span class="n">ThrowTerminatingError</span><span class="p">(</span><span class="k">new</span> <span class="n">ArgumentException</span><span class="p">(</span><span class="n">str4</span><span class="p">),</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">InvalidOperation</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">m_profilePicFolder</span> <span class="p">=</span> <span class="n">UserProfileGlobal</span><span class="p">.</span><span class="n">GetOrCreatePictureFolder</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">m_userProfileManager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">base</span><span class="p">.</span><span class="n">ThrowTerminatingError</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">ErrorCategory</span><span class="p">.</span><span class="n">ObjectNotFound</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Properties</span>
</span></span><span class="line"><span class="cl"><span class="na">    [Parameter(Mandatory=false)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">bool</span> <span class="n">CreateThumbnailsForImportedPhotos</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">m_createThumbnailsForImportedPhotos</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">m_createThumbnailsForImportedPhotos</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool?</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [ValidateNotNull, Parameter(Mandatory=true, ValueFromPipeline=true)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="n">SPSitePipeBind</span> <span class="n">MySiteHostLocation</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">m_SiteMySiteHost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">m_SiteMySiteHost</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="na">
</span></span></span><span class="line"><span class="cl"><span class="na">    [Parameter(Mandatory=false)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="kt">bool</span> <span class="n">NoDelete</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">get</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">m_noDelete</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">set</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="n">m_noDelete</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">bool?</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>From this we gather that the command has two modes depending on whether the
-CreateThumbnailsForImportedPhotos flag is specified.</p>
<p><!-- raw HTML omitted -->CreateThumbnailsForImportedPhotos specified<!-- raw HTML omitted --></p>
<p>This mode appears intended for those who are importing their pictures from
Active Directory (or other source) as a raw picture (Octet String for AD) in
bytes.</p>
<p><!-- raw HTML omitted -->CreateThumbnailsForImportedPhotos not specified<!-- raw HTML omitted --></p>
<p>This mode appears intended for the use cases where the PictureURL property has
been prepopulated with a URL that either points to an image in SharePoint or an
image available on another web server. This mode still will create thumbnails
for you, but it doesn&rsquo;t look for the temporary pictures in the form {GUID}_ID
to make the thumbnails from - it will try and access the picture located at the
URL specified in the PictureURL property.</p>
<p>So - if you&rsquo;re importing your pictures from Active Directory and a user removes
their picture from the directory, there is no means in the powershell (or
observed from the import process) to take care of removing the picture from
SharePoint.</p>
<p>I&rsquo;ll post more as more is learned. There doesn&rsquo;t seem to be much information on
some of these things.</p>

        </div>
    </div>
</article>

        </main>
        <div class="feedback">
    <div class="container">
        <div id="disqus_thread"></div>
    </div>
</div>
<script>
    (function () {
        var d = document, s = d.createElement('script');
        s.src = 'https://jonthenerd.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>


        <footer>
    <div class="container">
        built with <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/jonthenerd/jonthenerd.github.io">GitHub Pages</a> | <a href="/license">License</a>
    </div>
</footer>

    </body>
</html>
