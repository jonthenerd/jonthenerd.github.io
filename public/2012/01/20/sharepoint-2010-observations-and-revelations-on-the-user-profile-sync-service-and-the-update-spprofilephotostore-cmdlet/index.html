<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SharePoint 2010: Observations and Revelations on the User Profile Sync Service and the Update-SPProfilePhotoStore cmdlet &ndash; JonTheNerd</title>
    </head>

<body>
    
    <nav>
    <a href="/">JonTheNerd</a>
    <ul>
        <li><a href="/about">About</a></li>
    </ul>
</nav>
    
<h1>SharePoint 2010: Observations and Revelations on the User Profile Sync Service and the Update-SPProfilePhotoStore cmdlet</h1>
<p>These are my notes while trying to diagnose and better understnad some issues
and oddities with the SharePoint 2010 User Profile Service Application.</p>
<p>If you&rsquo;re wanting to populate pictures into people&rsquo;s profiles, you&rsquo;ll be using
the Update-SPProfilePhotoStore powershell cmdlet after a normal sync (full or
incremental - or your custom built one). This cmdlet is in
the Microsoft.Office.Server.UserProfiles dll, specifically the
Microsoft.Office.Server.UserProfiles.PowerShell.SPCmdletUserProfilePhotoStore
class. Thanks to the goodness that is
<!-- raw HTML omitted -->Redgate Reflector<!-- raw HTML omitted --> (a must have for any
SP developer), we can get a more clear undertanding of what the cmdlet is doing.
I&rsquo;ve written some comments to help understand what&rsquo;s going on, as well as
renamed some variables for the section I was more interested in understanding.
You&rsquo;ll want to open the code in a new window (highlight on the top right of the
code section), as some of the lines are quite long:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#a6e22e">[Cmdlet(&#34;Update&#34;, &#34;SPProfilePhotoStore&#34;)]</span>
<span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">sealed</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SPCmdletUserProfilePhotoStore</span> : SPCmdlet
{
    <span style="color:#75715e">// Fields
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool?</span> m_createThumbnailsForImportedPhotos = <span style="color:#66d9ef">null</span>;
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">bool?</span> m_noDelete = <span style="color:#66d9ef">null</span>;
    <span style="color:#66d9ef">private</span> SPFolder m_profilePicFolder;
    <span style="color:#66d9ef">private</span> SPSitePipeBind m_SiteMySiteHost;
    <span style="color:#66d9ef">private</span> UserProfileManager m_userProfileManager;

    <span style="color:#75715e">// Constructor
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> SPCmdletUserProfilePhotoStore()
    {
        <span style="color:#66d9ef">this</span>.m_createThumbnailsForImportedPhotos = <span style="color:#66d9ef">null</span>;
        <span style="color:#66d9ef">this</span>.m_noDelete = <span style="color:#66d9ef">null</span>;
    }

    <span style="color:#75715e">// Methods
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InternalProcessRecord()
    {
        <span style="color:#75715e">// Run the below section if -CreateThumbnailsForImportedPhotos has NOT been specified.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">this</span>.m_createThumbnailsForImportedPhotos.HasValue)
        {
            <span style="color:#75715e">// Enumerate through all UserProfiles
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">foreach</span> (UserProfile profile <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">this</span>.m_userProfileManager)
            {
                <span style="color:#66d9ef">try</span>
                {
                    <span style="color:#75715e">// Get the PictureURL property of the user profile
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">object</span> obj2 = profile[<span style="color:#e6db74">&#34;PictureURL&#34;</span>].Value;
                    <span style="color:#66d9ef">if</span> ((obj2 != <span style="color:#66d9ef">null</span>) &amp;&amp; !<span style="color:#66d9ef">string</span>.IsNullOrEmpty((<span style="color:#66d9ef">string</span>) obj2))
                    {
                        <span style="color:#75715e">// This user has a PictureURL property. Get the path
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">string</span> path = profile[<span style="color:#e6db74">&#34;PictureURL&#34;</span>].Value.ToString();
                        <span style="color:#66d9ef">string</span> format = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_GenericError_Text&#34;</span>);
                        format = <span style="color:#66d9ef">string</span>.Format(CultureInfo.InvariantCulture, format, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[] { path, (<span style="color:#66d9ef">string</span>) profile[<span style="color:#e6db74">&#34;AccountName&#34;</span>].Value });

                        <span style="color:#75715e">// If the PictureURL property has a link to the medium thumbnail, don&#39;t process further.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> (!Path.GetFileNameWithoutExtension(path).EndsWith(<span style="color:#e6db74">&#34;_MThumb&#34;</span>, StringComparison.Ordinal))
                        {
                            <span style="color:#66d9ef">bool</span> flag = <span style="color:#66d9ef">false</span>;
                            <span style="color:#66d9ef">byte</span>[] buffer = <span style="color:#66d9ef">null</span>;
                            <span style="color:#66d9ef">try</span>
                            {
                                <span style="color:#66d9ef">using</span> (SPSite site = <span style="color:#66d9ef">new</span> SPSite(path))
                                {
                                    <span style="color:#66d9ef">using</span> (SPWeb web = site.RootWeb)
                                    {
                                        <span style="color:#75715e">// Try and get a reference to the file specified. This can be in SharePoint somewhere on on another webserver.
</span><span style="color:#75715e"></span>                                        SPFile file = web.GetFile(path);
                                        <span style="color:#66d9ef">if</span> (file.Exists)
                                        {
                                            <span style="color:#66d9ef">try</span>
                                            {
                                                buffer = file.OpenBinary();
                                            }
                                            <span style="color:#66d9ef">catch</span> (Exception exception)
                                            {
                                                <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(format + exception.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                                buffer = <span style="color:#66d9ef">null</span>;
                                            }
                                        }
                                        <span style="color:#66d9ef">else</span>
                                        {
                                            <span style="color:#75715e">// The file doesn&#39;t exist. Write an error.
</span><span style="color:#75715e"></span>                                            <span style="color:#66d9ef">string</span> str4 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_FileNotFound_Text&#34;</span>);
                                            str4 = <span style="color:#66d9ef">string</span>.Format(CultureInfo.CurrentCulture, str4, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[] { path });
                                            <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> FileNotFoundException(format + str4), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                        }
                                    }
                                }
                            }
                            <span style="color:#66d9ef">catch</span> (FileNotFoundException)
                            {
                                <span style="color:#75715e">// File wasn&#39;t found using Object Model. Maybe it&#39;s on another webserver. Try and open the file using a WebClient instead of the Object Model
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">try</span>
                                {
                                    WebClient client = <span style="color:#66d9ef">new</span> WebClient();
                                    CredentialCache cache = <span style="color:#66d9ef">new</span> CredentialCache();
                                    cache.Add(<span style="color:#66d9ef">new</span> Uri(path), <span style="color:#e6db74">&#34;Ntlm&#34;</span>, CredentialCache.DefaultNetworkCredentials);
                                    client.Credentials = cache;
                                    buffer = client.DownloadData(<span style="color:#66d9ef">new</span> Uri(path));
                                }
                                <span style="color:#66d9ef">catch</span> (Exception exception2)
                                {
                                    <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(format + exception2.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                    buffer = <span style="color:#66d9ef">null</span>;
                                }
                            }
                            <span style="color:#66d9ef">string</span> str5 = <span style="color:#66d9ef">null</span>;
                            <span style="color:#75715e">// Did we read the file into memory?
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> (buffer != <span style="color:#66d9ef">null</span>)
                            {
                                <span style="color:#66d9ef">string</span> str7 = UrlUtility.ConvertToLegalFileName(profile[<span style="color:#e6db74">&#34;AccountName&#34;</span>].Value.ToString(), <span style="color:#e6db74">&#39;_&#39;</span>);
                                <span style="color:#66d9ef">string</span> str8 = <span style="color:#e6db74">&#34;.jpg&#34;</span>;
                                <span style="color:#66d9ef">try</span>
                                {
                                    <span style="color:#66d9ef">using</span> (MemoryStream stream = <span style="color:#66d9ef">new</span> MemoryStream(buffer))
                                    {
                                        <span style="color:#66d9ef">using</span> (Bitmap bitmap = <span style="color:#66d9ef">new</span> Bitmap(stream, <span style="color:#66d9ef">true</span>))
                                        {
                                            <span style="color:#75715e">// Create a large thumbnail
</span><span style="color:#75715e"></span>                                            UserProfilePhotos.CreateThumbnail(bitmap, UserProfilePhotos.LargeThumbnailSize, UserProfilePhotos.LargeThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str7 + <span style="color:#e6db74">&#34;_LThumb&#34;</span> + str8);
                                            <span style="color:#75715e">// Create a medium thumbnail
</span><span style="color:#75715e"></span>                                            SPFile file2 = UserProfilePhotos.CreateThumbnail(bitmap, UserProfilePhotos.MediumThumbnailSize, UserProfilePhotos.MediumThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str7 + <span style="color:#e6db74">&#34;_MThumb&#34;</span> + str8);
                                            <span style="color:#75715e">// Create a small thumbnail
</span><span style="color:#75715e"></span>                                            UserProfilePhotos.CreateThumbnail(bitmap, UserProfilePhotos.SmallThumbnailSize, UserProfilePhotos.SmallThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str7 + <span style="color:#e6db74">&#34;_SThumb&#34;</span> + str8);
                                            <span style="color:#75715e">// Get a URL to the Medium Size Thumbnail
</span><span style="color:#75715e"></span>                                            str5 = UrlUtility.EnsureTrailingSlash(<span style="color:#66d9ef">this</span>.m_userProfileManager.MySiteHostUrl) + file2.Url;
                                        }
                                    }
                                }
                                <span style="color:#66d9ef">catch</span> (Exception exception3)
                                {
                                    <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(format + exception3.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                    flag = <span style="color:#66d9ef">true</span>;
                                }
                            }
                            <span style="color:#75715e">// If the URL to the medium thumbnail isn&#39;t null and we successfully created the thumbnails...
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> ((str5 != <span style="color:#66d9ef">null</span>) &amp;&amp; !flag)
                            {
                                <span style="color:#75715e">// Set the PictureURL value
</span><span style="color:#75715e"></span>                                profile[<span style="color:#e6db74">&#34;PictureURL&#34;</span>].Value = str5;
                                profile.Commit();
                                <span style="color:#75715e">// Write to the log (verbose) that we set the Picture up.
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">string</span> str9 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_PhotoMoved_Text&#34;</span>);
                                str9 = <span style="color:#66d9ef">string</span>.Format(CultureInfo.InvariantCulture, str9, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[] { profile[<span style="color:#e6db74">&#34;AccountName&#34;</span>].ToString(), DateTime.Now.ToLongTimeString() });
                                <span style="color:#66d9ef">base</span>.WriteVerbose(str9);
                            }
                        }
                    }
                }
                <span style="color:#66d9ef">catch</span> (Exception exception4)
                {
                    <span style="color:#66d9ef">string</span> str10 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_GenericError_Text&#34;</span>);
                    str10 = <span style="color:#66d9ef">string</span>.Format(CultureInfo.InvariantCulture, str10, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[] { <span style="color:#66d9ef">string</span>.Empty, (<span style="color:#66d9ef">string</span>) profile[<span style="color:#e6db74">&#34;AccountName&#34;</span>].Value });
                    <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(str10 + exception4.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                }
            }
        }
        <span style="color:#75715e">// Run the below section if -CreateThumbnailsForImported has been specified
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span>
        {
            <span style="color:#75715e">// Get the MySiteHost Site Collection
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">using</span> (SPSite site2 = <span style="color:#66d9ef">new</span> SPSite(<span style="color:#66d9ef">this</span>.m_userProfileManager.MySiteHostUrl))
            {
                <span style="color:#75715e">// Access the MySiteHost RootWeb
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">using</span> (SPWeb web2 = site2.RootWeb)
                {
                    <span style="color:#75715e">// Get the PhotoListURL
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">string</span> importPhotoListUrl = UserProfileGlobal.GetImportPhotoListUrl(ProfileType.User) + <span style="color:#e6db74">&#34;/&#34;</span> + UserProfileGlobal.GetImportPhotoFolderName(web2.Locale) + <span style="color:#e6db74">&#34;/&#34;</span>;
                    <span style="color:#75715e">// Enumerate through all UserProfiles
</span><span style="color:#75715e"></span>                    <span style="color:#66d9ef">foreach</span> (UserProfile profile2 <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">this</span>.m_userProfileManager)
                    {
                        <span style="color:#75715e">// Get the filename of the photo, then the url to the photo, and finally the file itself
</span><span style="color:#75715e"></span>                        <span style="color:#75715e">// This is a combination of the UserProfileManager PartitionID (internal property) and the RecordId of the profile. This is the temporary picture file.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">string</span> importPhotoFilename = UserProfileGlobal.GetImportPhotoFilename(<span style="color:#66d9ef">this</span>.m_userProfileManager, profile2.RecordId);
                        <span style="color:#66d9ef">string</span> importPhotoFilenameWithListUrl = importPhotoListUrl + importPhotoFilename;
                        SPFile file3 = web2.GetFile(importPhotoFilenameWithListUrl);

                        <span style="color:#75715e">// If the file exists, run below.
</span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">if</span> ((file3 != <span style="color:#66d9ef">null</span>) &amp;&amp; file3.Exists)
                        {
                            <span style="color:#75715e">// Format an error message in case we need it later.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">string</span> str15 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_GenericError_Text&#34;</span>);
                            str15 = <span style="color:#66d9ef">string</span>.Format(CultureInfo.InvariantCulture, str15, <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">object</span>[] { file3.ToString(), (<span style="color:#66d9ef">string</span>) profile2[<span style="color:#e6db74">&#34;AccountName&#34;</span>].Value });

                            <span style="color:#75715e">// Try opening the file and reading it into memory
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">byte</span>[] buffer2 = <span style="color:#66d9ef">null</span>;
                            <span style="color:#66d9ef">try</span>
                            {
                                buffer2 = file3.OpenBinary();
                            }
                            <span style="color:#66d9ef">catch</span> (Exception exception5)
                            {
                                <span style="color:#75715e">// There was an exeption reading the picture file into memory. Write this error to a log, then set the buffer to null
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(str15 + exception5.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                buffer2 = <span style="color:#66d9ef">null</span>;
                            }

                            <span style="color:#75715e">// Check and see if we were able to read the file into memory successfully. Run below if we could.
</span><span style="color:#75715e"></span>                            <span style="color:#66d9ef">if</span> (buffer2 != <span style="color:#66d9ef">null</span>)
                            {
                                <span style="color:#75715e">// We&#39;ve got the temporary file in memory. Determine what we should rename it
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">string</span> str17 = profile2[<span style="color:#e6db74">&#34;AccountName&#34;</span>].Value.ToString().Replace(<span style="color:#e6db74">@&#34;\&#34;</span>, <span style="color:#e6db74">&#34;_&#34;</span>);
                                <span style="color:#66d9ef">string</span> str18 = <span style="color:#e6db74">&#34;.jpg&#34;</span>;
                                <span style="color:#66d9ef">string</span> mediumThumbnailURL = <span style="color:#66d9ef">null</span>;
                                <span style="color:#66d9ef">bool</span> createThumbnailsSuccess = <span style="color:#66d9ef">true</span>;
                                <span style="color:#66d9ef">try</span>
                                {
                                    <span style="color:#66d9ef">using</span> (MemoryStream stream2 = <span style="color:#66d9ef">new</span> MemoryStream(buffer2))
                                    {
                                        <span style="color:#66d9ef">using</span> (Bitmap bitmap2 = <span style="color:#66d9ef">new</span> Bitmap(stream2, <span style="color:#66d9ef">true</span>))
                                        {
                                            <span style="color:#75715e">// Create a Thumbnail - large size
</span><span style="color:#75715e"></span>                                            UserProfilePhotos.CreateThumbnail(bitmap2, UserProfilePhotos.LargeThumbnailSize, UserProfilePhotos.LargeThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str17 + <span style="color:#e6db74">&#34;_LThumb&#34;</span> + str18);
                                            <span style="color:#75715e">// Create a Thumbanil - medium size, and get a reference to the file it creates
</span><span style="color:#75715e"></span>                                            SPFile file4 = UserProfilePhotos.CreateThumbnail(bitmap2, UserProfilePhotos.MediumThumbnailSize, UserProfilePhotos.MediumThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str17 + <span style="color:#e6db74">&#34;_MThumb&#34;</span> + str18);
                                            <span style="color:#75715e">// Create a Thumbnail - small size
</span><span style="color:#75715e"></span>                                            UserProfilePhotos.CreateThumbnail(bitmap2, UserProfilePhotos.SmallThumbnailSize, UserProfilePhotos.SmallThumbnailSize, <span style="color:#66d9ef">this</span>.m_profilePicFolder, str17 + <span style="color:#e6db74">&#34;_SThumb&#34;</span> + str18);
                                            <span style="color:#75715e">// Build a URL that points to the medium size thumbnail
</span><span style="color:#75715e"></span>                                            mediumThumbnailURL = <span style="color:#66d9ef">this</span>.m_userProfileManager.MySiteHostUrl + file4.Url;
                                        }
                                    }
                                }
                                <span style="color:#66d9ef">catch</span> (Exception exception6)
                                {
                                    <span style="color:#66d9ef">base</span>.WriteError(<span style="color:#66d9ef">new</span> SPException(str15 + exception6.ToString()), ErrorCategory.WriteError, <span style="color:#66d9ef">null</span>);
                                    createThumbnailsSuccess = <span style="color:#66d9ef">false</span>;
                                }
                                <span style="color:#75715e">// Have we successfully created the thumbnails and have a path to the medium thumbnail?
</span><span style="color:#75715e"></span>                                <span style="color:#66d9ef">if</span> (createThumbnailsSuccess &amp;&amp; (mediumThumbnailURL != <span style="color:#66d9ef">null</span>))
                                {
                                    <span style="color:#75715e">// Set the PictureURL property
</span><span style="color:#75715e"></span>                                    profile2[<span style="color:#e6db74">&#34;PictureURL&#34;</span>].Value = mediumThumbnailURL;
                                    profile2.Commit();
                                    <span style="color:#75715e">// If -NoDelete wasn&#39;t specified, then delete the image with the Guid_ID pattern for this user profile.
</span><span style="color:#75715e"></span>                                    <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">this</span>.m_noDelete.HasValue || (<span style="color:#66d9ef">this</span>.m_noDelete == <span style="color:#66d9ef">false</span>))
                                    {
                                        file3.Delete();
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">override</span> <span style="color:#66d9ef">void</span> InternalValidate()
    {
        SPSite site = <span style="color:#66d9ef">this</span>.MySiteHostLocation.Read();
        <span style="color:#66d9ef">if</span> (site == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">string</span> message = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_NullMySiteHost_Text&#34;</span>);
            <span style="color:#66d9ef">base</span>.ThrowTerminatingError(<span style="color:#66d9ef">new</span> ArgumentException(message), ErrorCategory.InvalidArgument, <span style="color:#66d9ef">null</span>);
        }
        SPServiceContext serviceContext = SPServiceContext.GetContext(site);
        <span style="color:#66d9ef">if</span> (serviceContext == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">string</span> str2 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_ServerContextNotFound_Text&#34;</span>);
            <span style="color:#66d9ef">base</span>.ThrowTerminatingError(<span style="color:#66d9ef">new</span> ArgumentException(str2), ErrorCategory.ObjectNotFound, <span style="color:#66d9ef">null</span>);
        }
        <span style="color:#66d9ef">this</span>.m_userProfileManager = <span style="color:#66d9ef">new</span> UserProfileManager(serviceContext);
        <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.m_userProfileManager == <span style="color:#66d9ef">null</span>)
        {
            <span style="color:#66d9ef">string</span> str3 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_ProfManagerNotFound_Text&#34;</span>);
            <span style="color:#66d9ef">base</span>.ThrowTerminatingError(<span style="color:#66d9ef">new</span> ArgumentException(str3), ErrorCategory.ObjectNotFound, <span style="color:#66d9ef">null</span>);
        }
        <span style="color:#66d9ef">if</span> (!<span style="color:#66d9ef">this</span>.m_userProfileManager.IsProfileAdmin)
        {
            <span style="color:#66d9ef">string</span> str4 = StringResourceManager.GetString(<span style="color:#e6db74">&#34;Powershell_MovePictures_NotProfileAdmin_Text&#34;</span>);
            <span style="color:#66d9ef">base</span>.ThrowTerminatingError(<span style="color:#66d9ef">new</span> ArgumentException(str4), ErrorCategory.InvalidOperation, <span style="color:#66d9ef">null</span>);
        }
        <span style="color:#66d9ef">try</span>
        {
            <span style="color:#66d9ef">this</span>.m_profilePicFolder = UserProfileGlobal.GetOrCreatePictureFolder(<span style="color:#66d9ef">this</span>.m_userProfileManager);
        }
        <span style="color:#66d9ef">catch</span> (Exception exception)
        {
            <span style="color:#66d9ef">base</span>.ThrowTerminatingError(exception, ErrorCategory.ObjectNotFound, <span style="color:#66d9ef">null</span>);
        }
    }

    <span style="color:#75715e">// Properties
</span><span style="color:#75715e"></span><span style="color:#a6e22e">    [Parameter(Mandatory=false)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> CreateThumbnailsForImportedPhotos
    {
        <span style="color:#66d9ef">get</span>
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.m_createThumbnailsForImportedPhotos.Value;
        }
        <span style="color:#66d9ef">set</span>
        {
            <span style="color:#66d9ef">this</span>.m_createThumbnailsForImportedPhotos = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">bool?</span>(<span style="color:#66d9ef">value</span>);
        }
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [ValidateNotNull, Parameter(Mandatory=true, ValueFromPipeline=true)]</span>
    <span style="color:#66d9ef">public</span> SPSitePipeBind MySiteHostLocation
    {
        <span style="color:#66d9ef">get</span>
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.m_SiteMySiteHost;
        }
        <span style="color:#66d9ef">set</span>
        {
            <span style="color:#66d9ef">this</span>.m_SiteMySiteHost = <span style="color:#66d9ef">value</span>;
        }
    }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">    [Parameter(Mandatory=false)]</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">bool</span> NoDelete
    {
        <span style="color:#66d9ef">get</span>
        {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.m_noDelete.Value;
        }
        <span style="color:#66d9ef">set</span>
        {
            <span style="color:#66d9ef">this</span>.m_noDelete = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">bool?</span>(<span style="color:#66d9ef">value</span>);
        }
    }
}

</code></pre></div><p>From this we gather that the command has two modes depending on whether the
-CreateThumbnailsForImportedPhotos flag is specified.</p>
<p><!-- raw HTML omitted -->CreateThumbnailsForImportedPhotos specified<!-- raw HTML omitted --></p>
<p>This mode appears intended for those who are importing their pictures from
Active Directory (or other source) as a raw picture (Octet String for AD) in
bytes.</p>
<p><!-- raw HTML omitted -->CreateThumbnailsForImportedPhotos not specified<!-- raw HTML omitted --></p>
<p>This mode appears intended for the use cases where the PictureURL property has
been prepopulated with a URL that either points to an image in SharePoint or an
image available on another web server. This mode still will create thumbnails
for you, but it doesn&rsquo;t look for the temporary pictures in the form {GUID}_ID
to make the thumbnails from - it will try and access the picture located at the
URL specified in the PictureURL property.</p>
<p>So - if you&rsquo;re importing your pictures from Active Directory and a user removes
their picture from the directory, there is no means in the powershell (or
observed from the import process) to take care of removing the picture from
SharePoint.</p>
<p>I&rsquo;ll post more as more is learned. There doesn&rsquo;t seem to be much information on
some of these things.</p>


    
    
    
</body>

</html>
